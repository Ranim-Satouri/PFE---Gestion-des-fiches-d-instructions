
<div class="h-full flex flex-col" >
    <div class="w-full z-50 bg-gray-200 dark:bg-gray-800 rounded-lg mb-4 p-4">
        <!-- Search Bar and Filters Row -->
        <div class="flex flex-col sm:flex-row items-center justify-between gap-2 sm:gap-2">
          <!-- Search Bar -->
          <div class="relative w-full sm:w-1/4">
            <input
              type="search"
              [(ngModel)]="searchbar" placeholder="Rechercher ..."
              class="no-native-clear uniform-placeholder  w-full h-10 px-4 py-2 text-gray-900 bg-white
               dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-400
                dark:focus:ring-blue-500 dark:focus:border-blue-500 focus:border-blue-500 
                 dark:text-white outline-none transition-all duration-200"/>
            <!-- Search Icon -->
            <button class="absolute inset-y-0 right-0 flex items-center pr-3">
              <svg
                class="text-gray-500 h-4 w-4 fill-current dark:text-gray-400"
                xmlns="http://www.w3.org/2000/svg" viewBox="0 0 56.966 56.966" >
                <path
                  d="M55.146,51.887L41.588,37.786c3.486-4.144,5.396-9.358,5.396-14.786c0-12.682-10.318-23-23-23s-23,10.318-23,23 s10.318,23,23,23c4.761,0,9.298-1.436,13.177-4.162l13.661,14.208c0.571,0.593,1.339,0.92,2.162,0.92 c0.779,0,1.518-0.297,2.079-0.837C56.255,54.982,56.293,53.08,55.146,51.887z M23.984,6c9.374,0,17,7.626,17,17s-7.626,17-17,17 s-17-7.626-17-17S14.61,6,23.984,6z"/>
              </svg></button>
            <!-- Clear Button -->
            <button
              *ngIf="searchbar"
              (click)="searchbar = ''"
              class="absolute right-8 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-400" >
              <svg
                xmlns="http://www.w3.org/2000/svg" class="text-gray-600 fill-current dark:text-gray-400" height="18" width="18" viewBox="0 0 512 512">
                <path
                  d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM175 175c9.4-9.4 24.6-9.4 33.9 0l47 47 47-47c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9l-47 47 47 47c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0l-47-47-47 47c-9.4 9.4-24.6 9.4-33.9 0s-9.4-24.6 0-33.9l47-47-47-47c-9.4-9.4-9.4-24.6 0-33.9z"/>
              </svg>
            </button>
          </div>
      
          <!-- Reference and Indice Inputs -->
            <input
              placeholder="Référence"
              [(ngModel)]="refSearchText"
              (input)="applyFilters()"
              class="uniform-placeholder w-[15%] h-10 px-3 py-2  rounded-lg bg-white dark:bg-gray-700 dark:text-white border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 dark:focus:ring-blue-500 dark:focus:border-blue-500 outline-none transition-all duration-200"/>
            <input
              placeholder="Indice"
              [(ngModel)]="indiceSearchText"
              (input)="applyFilters()"
              class="uniform-placeholder w-[15%] h-10 px-3 py-2 rounded-lg bg-white dark:bg-gray-700 dark:text-white border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 dark:focus:ring-blue-500 dark:focus:border-blue-500 outline-none transition-all duration-200" />
      <!-- Ligne Input -->
      <div class="relative w-full sm:w-48">
        <input placeholder="Ligne" [(ngModel)]="ligneSearchText" (input)="applyFilters()"
        class="uniform-placeholder w-full h-10 px-4 py-2 rounded-lg bg-white dark:bg-gray-700 dark:text-white border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 dark:focus:ring-blue-500 dark:focus:border-blue-500 outline-none transition-all duration-200"  />
            </div>  
        <!-- Operation Input -->
        <div class="relative w-full sm:w-48">
            <input
            placeholder="Opération"
            [(ngModel)]="OperationSearchText"
            (input)="applyFilters()" class="uniform-placeholder w-full h-10 px-4 py-2 rounded-lg bg-white
            dark:bg-gray-700 dark:text-white border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 dark:focus:ring-blue-500 dark:focus:border-blue-500 outline-none transition-all duration-200"/>
        </div>  
          <!-- Famille Dropdown -->
          <div class="relative w-full sm:w-48">
            <input
              #familleInput
              class="uniform-placeholder w-full h-10 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-400 focus:ring-2 focus:ring-blue-400 dark:focus:ring-blue-500 focus:border-blue-400 dark:focus:border-blue-500 outline-none transition-all duration-200"
              type="text"
              autocomplete="off" [value]="familleSearchText"
              (input)="onFamilleSearchChange($event)"
              placeholder="Famille"
              name="familleSearchText"/>
            <div
              #familleArrowButton
              class="absolute top-1/2 right-3 -translate-y-1/2 cursor-pointer"
              (click)="toggleFamilleDropdown()" >
              <svg
                class="shrink-0 size-3.5 text-gray-500 dark:text-gray-400"
                xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"  stroke-linejoin="round">
                <path d="m7 15 5 5 5-5"></path><path d="m7 9 5-5 5 5"></path></svg>
            </div>
            <div
              *ngIf="showFamilleDropdown"
              id="familleDropDown" #familleDropdown
              class="absolute w-full bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg mt-1 max-h-40 overflow-y-auto shadow-lg z-[1000]"
              [ngClass]="{ 'invisible': !isFamilleDropdownPositioned }">
              <div
                *ngFor="let f of filteredFamilles"
                (click)="selectFamille(f)"
                class="cursor-pointer py-2 px-4 text-sm text-gray-800 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600">
                {{ f.nomFamille }}
              </div>
            </div>
          </div>
          <!-- Zone Dropdown -->
          <div class="relative w-[21%]" #zoneToggleButton (click)="toggleZoneDropdown()">
            <div 
            class="uniform-placeholder w-full h-10 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-400 focus:ring-2 focus:ring-blue-400 dark:focus:ring-blue-500 focus:border-blue-400 dark:focus:border-blue-500 outline-none transition-all duration-200"
            >
            {{ selectedZones.length > 0 ? getSelectedZoneNames() : 'Zone' }}
            </div>
            <div class="absolute top-1/2 right-3 -translate-y-1/2 cursor-pointer text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-white transition">
              <svg class="shrink-0 size-3.5 w-4 h-4"
                xmlns="http://www.w3.org/2000/svg" width="24"height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m7 15 5 5 5-5"></path><path d="m7 9 5-5 5 5"></path>
              </svg>
            </div>
            <div
              *ngIf="zoneDropdownOpen" #zoneDropdown
              class="absolute w-full bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg mt-1 max-h-40 overflow-y-auto shadow-lg z-[1000]">
              <label *ngFor="let zone of zones"
                class="flex items-center px-4 py-2  hover:bg-gray-200 dark:hover:bg-gray-600 cursor-pointer">
                <input
                  type="checkbox"
                  [value]="zone.idZone"
                  (change)="onCheckboxChange($event)"
                  [checked]="zone.idZone !== undefined && selectedZones.includes(zone.idZone)"
                  class="hidden peer"/>
                <div
                  class="w-4 h-4 mr-2 flex items-center justify-center rounded border-2  border-gray-400 peer-checked:bg-blue-600 peer-checked:border-blue-600 peer-checked:[&>svg]:block transition-colors duration-300 ease-in-out">
                  <svg
                    class="w-4 h-4 text-white hidden" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                  </svg> </div> <span style="font-size: 13px">{{ zone.nom }}</span> </label>
            </div>
          </div>
      
<!-- Situation Dropdown -->
<div class="relative w-full sm:w-48" #situationToggleButton (click)="toggleSituationDropdown()">
  <!-- Situation Dropdown -->
<div
class="w-full h-10 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 uniform-placeholder focus:ring-2 focus:ring-blue-400 dark:focus:ring-blue-500 focus:border-blue-400 dark:focus:border-blue-500 cursor-pointer transition-all duration-200">
{{ selectedSituations.length > 0 ? getSelectedSituationNames() : 'Situation' }}
</div>
    <div
      class="absolute top-1/2 right-3 -translate-y-1/2 cursor-pointer text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-white transition">
      <svg
        class="shrink-0 size-3.5 w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m7 15 5 5 5-5"></path> <path d="m7 9 5-5 5 5"></path>
      </svg>
    </div>
    <div
      *ngIf="situationDropdownOpen"
      #situationDropdown
      class="absolute w-full bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg mt-1 max-h-40 overflow-y-auto shadow-lg z-[1000]">
      <label  *ngFor="let situation of situations"
        class="flex items-center px-4 py-2 hover:bg-gray-200 dark:hover:bg-gray-600 cursor-pointer">
        <input
          type="checkbox"
          [value]="situation"
          (change)="onSituationCheckboxChange($event)"
          [checked]="selectedSituations.includes(situation)"
          class="hidden peer"/>
        <div class="w-4 h-4 mr-2 flex items-center justify-center rounded border-2 border-gray-400 peer-checked:bg-blue-600 peer-checked:border-blue-600 peer-checked:[&>svg]:block transition-colors duration-300 ease-in-out">
          <svg class="w-4 h-4 text-white hidden"
            fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg></div><span style="font-size: 13px">{{ situation }}</span></label>
    </div>
  </div>
          <!-- Buttons -->
          <div class="flex items-center gap-2">
            <!-- Reset Filters Button -->
            <button
              (click)="clearFilters()"
              class="w-fit mx-2 px-1 h-10 bg-gray-trans text-gray-400 rounded-lg hover:text-gray-500" > <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 25 25" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="30" height="31" stroke-width="2.25"> <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"></path> <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path> </svg>  </button>
            <!-- Add Fiche Button -->
            <button
              *ngIf="hasPermission('creer_fiche')"
              (click)="showFicheForm()"
              class="p-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition duration-200" >
              <svg width="14" height="14" viewBox="0 0 10 10" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M1.22229 5.00019H8.77785M5.00007 8.77797V1.22241"
                  stroke="white"
                  stroke-width="1.6" stroke-linecap="round"
                  stroke-linejoin="round" ></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    <div class="mb-2 overflow-x-auto shadow-md rounded-lg max-h-[calc(100%-132px)] overflow-y-auto custom-scrollbar-container " (scroll)="onScroll()">
        <table class="w-full text-xs text-left rtl:text-right text-gray-700 dark:text-gray-400 ">
            <thead class="text-xs text-gray-700 uppercase bg-gray-300 dark:bg-gray-700 dark:text-gray-400 sticky-top">
                <tr>
                    <th scope="col" class="px-2 pl-4 py-3 "><div class="flex items-center">#</div></th>
                    <th scope="col" class="px-2 py-3 ">Produit</th>
                    <th scope="col" class="px-2 py-3 "><div class="flex items-center">Référence</div></th>
                    <th scope="col" class="px-2 py-3 "><div class="flex items-center">Indice</div></th>
                    <th scope="col" class="px-2 py-3 "><div class="flex items-center">Famille</div></th>
                    <th scope="col" class="px-2 py-3 "><div class="flex items-center">Zone</div></th>
                    <th scope="col" class="px-2 py-3 "><div class="flex items-center">Ligne</div></th>
                    <th scope="col" class="px-2 py-3 "><div class="flex items-center">Operation</div></th>
                    <th scope="col" class="px-2 py-3 "><div class="flex items-center">Situation</div></th>

                    <th *ngIf="hasPermission('valider_fiche_IQP') || hasPermission('valider_fiche_IPDF')" scope="col" class=" py-3 ">Valider</th>

                    <th  scope="col" class="px-2 py-3 ">
                        <div class="flex items-center">
                            Modifié le
                            <svg (click)="sortByDate()" class="w-3 h-3 ms-1.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8.574 11.024h6.852a2.075 2.075 0 0 0 1.847-1.086 1.9 1.9 0 0 0-.11-1.986L13.736 2.9a2.122 2.122 0 0 0-3.472 0L6.837 7.952a1.9 1.9 0 0 0-.11 1.986 2.074 2.074 0 0 0 1.847 1.086Zm6.852 1.952H8.574a2.072 2.072 0 0 0-1.847 1.087 1.9 1.9 0 0 0 .11 1.985l3.426 5.05a2.123 2.123 0 0 0 3.472 0l3.427-5.05a1.9 1.9 0 0 0 .11-1.985 2.074 2.074 0 0 0-1.846-1.087Z"/>
                            </svg>
                        </div>
                    </th>
                    <th scope="col" class="py-3 pr-6 font-medium"></th>
                    <th scope="col" class=" py-3 "></th>
                    <th scope="col" class="px-4 py-3 "></th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let fiche of filteredFiches| filter:searchbar | paginate: { itemsPerPage: itemsPerPage, currentPage: page }; let i = index"
                    class="bg-gray-50 border-b dark:bg-gray-800 dark:border-gray-700 border-gray-200 dark:hover:bg-hoverColor hover:bg-gray-100">
                    <th scope="col" class="px-2 pl-4 py-2 font-medium text-gray-900 whitespace-nowrap dark:text-white">{{fiche.idFiche}}</th>
                    <th scope="col" class="px-2 py-2 font-medium text-gray-900 whitespace-nowrap dark:text-white">{{fiche.produit.nomProduit}}</th>
                    <th scope="col" class="px-2 py-2 font-medium">{{fiche.produit.ref}}</th>
                    <th scope="col" class="px-2 py-2 font-medium">{{fiche.produit.indice}}</th>
                    <th scope="col" class="px-2 py-2 font-medium">{{fiche.produit.famille.nomFamille}}</th>
                    <th class="px-2 py-2">
                        <ng-container *ngIf="fiche.typeFiche === 'OPERATION'"> {{ fiche.operation?.ligne?.zone?.nom }}</ng-container>
                        
                        <ng-container *ngIf="fiche.typeFiche === 'LIGNE'"> {{ fiche.ligne?.zone?.nom }}</ng-container>
                        
                        <ng-container *ngIf="fiche.typeFiche === 'ZONE'">{{ fiche.zone?.nom }} </ng-container>
                    </th>
                
                      <!-- Données de la Ligne -->
                    <th class="px-2 py-2">
                        <ng-container *ngIf="fiche.typeFiche === 'OPERATION'">{{ fiche.operation?.ligne?.nom }}</ng-container>
                        
                        <ng-container *ngIf="fiche.typeFiche === 'LIGNE'">{{ fiche.ligne?.nom }} </ng-container>
                         
                        <ng-container *ngIf="fiche.typeFiche === 'ZONE'">Tous</ng-container>
                    </th>
                    <th class="px-2 py-2">
                        <ng-container *ngIf="fiche.typeFiche === 'OPERATION'">{{fiche.operation?.nom}} </ng-container>
                        
                        <ng-container *ngIf="fiche.typeFiche === 'LIGNE'">Tous </ng-container>
                        
                        <ng-container *ngIf="fiche.typeFiche === 'ZONE'">Tous</ng-container>
                    </th>

                    <th
                        scope="col"
                        class="px-2 py-3 font-medium text-sm"
                        [ngSwitch]="fiche.status">

                        <span *ngSwitchCase="'ACCEPTEDIPDF'" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 dark:bg-green-100/80 text-green-800 dark:text-green-900">
                            <!-- <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
                                <path d="M8.56 3.69a9 9 0 0 0 -2.92 1.95"></path>
                                <path d="M3.69 8.56a9 9 0 0 0 -.69 3.44"></path>
                                <path d="M3.69 15.44a9 9 0 0 0 1.95 2.92"></path>
                                <path d="M8.56 20.31a9 9 0 0 0 3.44 .69"></path>
                                <path d="M15.44 20.31a9 9 0 0 0 2.92 -1.95"></path>
                                <path d="M20.31 15.44a9 9 0 0 0 .69 -3.44"></path>
                                <path d="M20.31 8.56a9 9 0 0 0 -1.95 -2.92"></path>
                                <path d="M15.44 3.69a9 9 0 0 0 -3.44 -.69"></path>
                                <path d="M9 12l2 2l4 -4"></path>
                              </svg> -->
                              <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
                                <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                                <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"></path>
                                <path d="M9 15l2 2l4 -4"></path>
                              </svg>IPDF</span>
                        <span *ngSwitchCase="'ACCEPTEDIQP'" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 dark:bg-green-100/80 text-green-800 dark:text-green-900">
                            <!-- <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
                                <path d="M8.56 3.69a9 9 0 0 0 -2.92 1.95"></path>
                                <path d="M3.69 8.56a9 9 0 0 0 -.69 3.44"></path>
                                <path d="M3.69 15.44a9 9 0 0 0 1.95 2.92"></path>
                                <path d="M8.56 20.31a9 9 0 0 0 3.44 .69"></path>
                                <path d="M15.44 20.31a9 9 0 0 0 2.92 -1.95"></path>
                                <path d="M20.31 15.44a9 9 0 0 0 .69 -3.44"></path>
                                <path d="M20.31 8.56a9 9 0 0 0 -1.95 -2.92"></path>
                                <path d="M15.44 3.69a9 9 0 0 0 -3.44 -.69"></path>
                                <path d="M9 12l2 2l4 -4"></path>
                              </svg> -->
                              <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
                                <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                                <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"></path>
                                <path d="M9 15l2 2l4 -4"></path>
                              </svg>
                            IQP</span>
                        <span *ngSwitchCase="'REJECTEDIPDF'" class="inline-flex items-center justify-between px-3 py-1 rounded-full text-xs font-semibold bg-red-100 dark:bg-red-100/90 text-red-800  dark:text-red-900 w-fit space-x-2">
                            <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
                                <path d="M3 14m0 1a1 1 0 0 1 1 -1h1a1 1 0 0 1 1 1v3a1 1 0 0 1 -1 1h-1a1 1 0 0 1 -1 -1z"></path>
                                <path d="M6 15a1 1 0 0 1 1 -1h3.756a1 1 0 0 1 .958 .713l1.2 3c.09 .303 .133 .63 -.056 .884c-.188 .254 -.542 .403 -.858 .403h-2v2.467a1.1 1.1 0 0 1 -2.015 .61l-1.985 -3.077v-4z"></path>
                                <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                                <path d="M5 11v-6a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2h-2.5"></path>
                              </svg>
                              IPDF
                            <!-- <svg (click)="openCommentModal(fiche.commentaire)" class="w-4 h-4 cursor-pointer hover:text-red-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.96 9.96 0 01-5.917-1.908L3 20l1.67-3.609A8.963 8.963 0 013 12 c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg> -->
                            <svg (click)="openCommentModal(fiche.commentaire)" class="w-4 h-4 cursor-pointer hover:text-red-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
                                <path d="M12 11v.01"></path>
                                <path d="M8 11v.01"></path>
                                <path d="M16 11v.01"></path>
                                <path d="M18 4a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-5l-5 3v-3h-2a3 3 0 0 1 -3 -3v-8a3 3 0 0 1 3 -3z"></path>
                            </svg>
                        </span>
                        <span *ngSwitchCase="'REJECTEDIQP'" class="inline-flex items-center justify-between px-3 py-1 rounded-full text-xs font-semibold bg-red-100 dark:bg-red-100/90 dark:text-red-900 text-red-800 w-fit space-x-2">
                            <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
                                <path d="M3 14m0 1a1 1 0 0 1 1 -1h1a1 1 0 0 1 1 1v3a1 1 0 0 1 -1 1h-1a1 1 0 0 1 -1 -1z"></path>
                                <path d="M6 15a1 1 0 0 1 1 -1h3.756a1 1 0 0 1 .958 .713l1.2 3c.09 .303 .133 .63 -.056 .884c-.188 .254 -.542 .403 -.858 .403h-2v2.467a1.1 1.1 0 0 1 -2.015 .61l-1.985 -3.077v-4z"></path>
                                <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                                <path d="M5 11v-6a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2h-2.5"></path>
                            </svg>
                            IQP
                            <!-- <svg (click)="openCommentModal(fiche.commentaire)" class="w-4 h-4 cursor-pointer hover:text-red-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.96 9.96 0 01-5.917-1.908L3 20l1.67-3.609A8.963 8.963 0 013 12 c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg> -->
                            <svg (click)="openCommentModal(fiche.commentaire)" class="w-4 h-4 cursor-pointer hover:text-red-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
                                <path d="M12 11v.01"></path>
                                <path d="M8 11v.01"></path>
                                <path d="M16 11v.01"></path>
                                <path d="M18 4a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-5l-5 3v-3h-2a3 3 0 0 1 -3 -3v-8a3 3 0 0 1 3 -3z"></path>
                            </svg>
                        </span>
                        <span *ngSwitchCase="'PENDING'" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-700">En attente</span>
                        <span *ngSwitchCase="'EXPIRED'" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">Expirée</span>
                    </th>   

                    <th *ngIf="hasPermission('valider_fiche_IQP') || hasPermission('valider_fiche_IPDF')" scope="col" class=" py-3 font-medium" >                       
                        <app-fiche-validation [fiche]="fiche" (ficheUpdated)="getFiches()"></app-fiche-validation>
                    </th> 

                    <th  scope="col" class="px-2 py-2 font-medium">{{fiche.modifieLe |date:'dd/MM/yyyy, HH:mm' }}</th>
                    <th scope="col" class="py-3 pr-4 font-medium">
                        <!-- Icône QR Code -->
                        <svg  (click)="generateQrCode(fiche.pdf)" class="w-6 h-6  text-gray-700 dark:text-gray-400 hover:text-black dark:hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linejoin="round" stroke-width="2" d="M4 4h6v6H4V4Zm10 10h6v6h-6v-6Zm0-10h6v6h-6V4Zm-4 10h.01v.01H10V14Zm0 4h.01v.01H10V18Zm-3 2h.01v.01H7V20Zm0-4h.01v.01H7V16Zm-3 2h.01v.01H4V18Zm0-4h.01v.01H4V14Z"/>
                            <path stroke="currentColor" stroke-linejoin="round" stroke-width="2" d="M7 7h.01v.01H7V7Zm10 10h.01v.01H17V17Z"/>
                        </svg>
                      </th>
                    <th  scope="col" class=" py-2 font-medium">
                        <svg (click)="downloadFile(fiche.pdf)" class="hover:text-black dark:hover:text-white"  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
                            <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                            <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"></path>
                            <path d="M12 17v-6"></path>
                            <path d="M9.5 14.5l2.5 2.5l2.5 -2.5"></path>
                        </svg>
                    </th>
                    
                    <th class="px-4 py-2 text-right relative">
                        <div class="relative inline-block text-left" *ngIf="hasPermission('modifier_fiche') || hasPermission('consulter_historique') || hasPermission('supprimer_fiche') || fiche.ficheAQL !== '' ">
                            <button (click)="toggleDropdown(i, $event,fiche)" 
                            [ngClass]="{'dark:bg-gray-600 bg-gray-300': dropdownOpen === i , ' bg-transparent': dropdownOpen !== i }"
                            class="p-1 dark:hover:bg-gray-600  hover:bg-gray-300 rounded-full focus:outline-none">
                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 4 15">
                                    <path d="M3.5 1.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 6.041a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 5.959a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z"/>
                                </svg>
                            </button>   
                            <!-- Menu déroulant -->
                            <div *ngIf="dropdownOpen === i"
                                id="dropdownDots-{{i}}"
                                [ngStyle]="{ top: dropdownPosition.top + 'px', left: dropdownPosition.left + 'px' }"
                                class="fixed w-40 
                                        bg-gray-100 dark:bg-gray-800 
                                        border border-gray-300 dark:border-gray-600 
                                        rounded-md shadow-md z-50 transition-all"
                                [ngClass]="{ 'origin-bottom-right': displayAbove, 'origin-top-right': !displayAbove }">


                            <ul class="py-2 text-sm text-gray-700 dark:text-gray-200 font-medium space-y-1" >
                                <li>
                                <a (click)="downloadFile(fiche.ficheAQL!)" [ngClass]="{ 'hidden' : fiche.ficheAQL === ''}" class="flex items-center mx-1 px-4 py-2 hover:bg-gray-300 dark:hover:bg-gray-700 rounded-lg cursor-pointer transition-all">
                                    <!-- File Icon -->                                 
                                    <svg class="w-5 h-5 mr-3 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
                                        <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                                        <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"></path>
                                        <path d="M9 15l2 2l4 -4"></path>
                                      </svg>
                                    Fiche AQL
                                </a>
                                </li>
                                <!-- <li>
                                <a class="flex items-center mx-1 px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg cursor-pointer transition-all">
                                    
                                    <svg class="w-5 h-5 mr-3 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
                                        <path d="M8.56 3.69a9 9 0 0 0 -2.92 1.95"></path>
                                        <path d="M3.69 8.56a9 9 0 0 0 -.69 3.44"></path>
                                        <path d="M3.69 15.44a9 9 0 0 0 1.95 2.92"></path>
                                        <path d="M8.56 20.31a9 9 0 0 0 3.44 .69"></path>
                                        <path d="M15.44 20.31a9 9 0 0 0 2.92 -1.95"></path>
                                        <path d="M20.31 15.44a9 9 0 0 0 .69 -3.44"></path>
                                        <path d="M20.31 8.56a9 9 0 0 0 -1.95 -2.92"></path>
                                        <path d="M15.44 3.69a9 9 0 0 0 -3.44 -.69"></path>
                                        <path d="M9 12l2 2l4 -4"></path>
                                      </svg>
                                    Approuver
                                </a>
                                </li> -->
                                <li>
                                <a *ngIf="hasPermission('modifier_fiche')" (click)="openUpdateForm(fiche)" class="flex items-center mx-1 px-4 py-2 hover:bg-gray-300 dark:hover:bg-gray-700 rounded-lg cursor-pointer transition-all">
                                    <!-- Pencil Icon -->
                                    <svg class="w-5 h-5 mr-3 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
                                        <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4"></path>
                                        <path d="M13.5 6.5l4 4"></path>
                                        <path d="M16 19h6"></path>
                                      </svg>
                                    Modifier
                                </a>
                                </li>
                                <li>
                                <a *ngIf="hasPermission('consulter_historique')" (click)="openFicheHistory(fiche.idFiche)"
                                 class="flex items-center mx-1 px-4 py-2 hover:bg-gray-300 dark:hover:bg-gray-700 rounded-lg cursor-pointer transition-all">
                                    <!-- History Icon -->
                                    <svg class="w-5 h-5 mr-3 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
                                    <polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0-1.38-5H1"/><path d="M12 7v5l3 3"/></svg>
                                    Historique</a></li>
                                <li>
                                <a  *ngIf="hasPermission('supprimer_fiche')" class="flex items-center  mx-1 px-4 py-2 text-red-600 hover:bg-red-500 dark:hover:bg-red-600 hover:text-white dark:hover:text-white rounded-lg cursor-pointer transition-all"
                                    (click)="openDeleteModel(fiche)">
                                    <!-- Trash Icon -->    
                                    <svg class="w-5 h-5 mr-3  " xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2">
                                        <path d="M4 7l16 0"></path>
                                        <path d="M10 11l0 6"></path>
                                        <path d="M14 11l0 6"></path>
                                        <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path>
                                        <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"></path>
                                      </svg>
                                    Supprimer
                                </a>
                                </li>
                            </ul>
                            </div>

                        </div>
                    </th>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    <div class=" flex sm:flex-row justify-between items-center px-4 rounded-lg h-10 flex-col gap-4">
        <div class="text-sm text-slate-500">
            Affichage <b>{{ (page - 1) * itemsPerPage + 1 }}</b> - <b>{{ (page * itemsPerPage > fiches.length ? fiches.length : page * itemsPerPage) }}</b> de <b>{{ fiches.length }}</b> éléments
        </div>
       <div class="flex space-x-3 flex-row sm:flex-row flex-col">
            <form class="max-w-sm mx-auto flex flex-row gap-3 items-center ">
                <label for="countries" class="block text-sm font-medium text-slate-500">Élément par page</label>
                <div class="relative">
                  <select id="countries" [(ngModel)]="itemsPerPage" name="itemsPerPage"  class="bg-gray-50 border-2 border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:outline-none focus:border-blue-500 block w-16 h-8 px-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-gray-400  dark:focus:border-blue-500">
                    <option value="5" selected>5</option>
                    <option value="10">10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                    <option *ngIf="fiches.length > 20" value="{{fiches.length}}">{{fiches.length}}</option>

                  </select>
                  <!-- Flèche SVG personnalisée -->
                  <svg class="absolute right-2 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-500 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
            </form>
            <pagination-controls (pageChange)="page = $event" class="text-gray-800 dark:text-white  " previousLabel="Précédent" nextLabel="Suivant" ></pagination-controls>
        </div>
    </div>
</div>


<app-delete-confirm 
    [isOpen]="isDeleteModelOpen"
    [title]="'cette fiche'"
    [message1]="''"
    [message2]="''"
    (onConfirm)="deleteFiche(selectedFiche )"
    (onCancel)="closeDeleteModel()">
</app-delete-confirm>

<app-fiche-form
*ngIf="showForm"
(close)="hideForm()"
[fiche]="ficheToUpdate!"
></app-fiche-form>


<!-- Modal pour commentaire -->
<!-- <div *ngIf="isCommentModalOpen" class="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
    <div class="fixed bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-[90%] relative">
        <button
            (click)="isCommentModalOpen = false"
            type="button"
            class="absolute top-2 right-2 text-gray-500 hover:text-gray-600 dark:hover:text-white hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg w-8 h-8 flex items-center justify-center transition"
            >
            <svg class="w-3 h-3" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
            </svg>
        </button>
        <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Commentaire</h2>
        <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-line break-words">
        {{ rejetComment }}
        </p>
    </div>
</div> -->
  <!-- Modal pour commentaire -->
<div *ngIf="isCommentModalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70  ">
    <div
      class="relative bg-gray-100 dark:bg-gray-900 rounded-lg shadow-2xl p-6 w-full max-w-md mx-4 animate-fade-in-up transition-all border dark:border-gray-700"
    >
      <!-- Bouton Fermer -->
      <button
            (click)="isCommentModalOpen = false"
            type="button"
            class="absolute top-2 right-2 text-gray-500 hover:text-gray-600 dark:hover:text-white hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg w-8 h-8 flex items-center justify-center transition"
            >
            <svg class="w-3 h-3" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
            </svg>
        </button>
  
      <!-- Titre -->
      <h2 class="text-xl font-bold text-gray-800 dark:text-white">Commentaire</h2>
      <hr class="border-t border-gray-400 dark:border-gray-700 my-2"/>
      <!-- Contenu -->
      <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-line break-words">
        {{ rejetComment }}
      </p>
    </div>
  </div>
  

<div *ngIf="isQrPopupOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 bg-opacity-50 ">
    <div class="bg-white dark:bg-gray-900 p-6 rounded-lg shadow-lg max-w-sm w-full space-y-4  border  dark:border-gray-700 ">
      <h3 class="text-xl font-semibold text-center text-gray-800 dark:text-white">QR Code</h3>
      <div class="flex justify-center">
        <img [src]="qrCodeUrl" alt="QR Code" class="w-48 h-48 rounded-md shadow-md" />
      </div>
      <div class="flex justify-center">
        <button 
          (click)="closeQrPopup()" 
          class="py-2 px-4 items-center text-sm font-medium rounded border border-transparent bg-blue-600 text-white hover:bg-blue-700 focus:outline-hidden focus:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none">
          Fermer
        </button>
      </div>
    </div>
</div>
<app-fiche-history #ficheHistoryComponent ></app-fiche-history>